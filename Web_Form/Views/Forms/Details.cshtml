@model FullFormViewModel
@using System.Linq
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager
@{
    var CurrentUser = UserManager.GetUserAsync(User).Result;
    var userId = UserManager.GetUserId(User);
    var UniqId = Guid.NewGuid();
}
@{
    var hasLiked = ViewBag.HasLiked;
    var formId = ViewBag.FormId as int?;
}

<title>@Model.TblForm.Title</title>

<div class="container">
    <h1><i class="fas fa-poll"></i> @Model.TblForm.Title</h1>
    <p>@Model.TblForm.Description</p>

    <!-- Progress Indicator -->
    <div class="progress-indicator d-flex justify-content-between">
        <div class="progress-step text-center">
            <i class="fas fa-clipboard"></i>
            <p>Create</p>
        </div>
        <div class="progress-step text-center">
            <i class="fas fa-tasks"></i>
            <p>Answer</p>
        </div>
        <div class="progress-step text-center">
            <i class="fas fa-check-circle"></i>
            <p>Submit</p>
        </div>
    </div>

    @using (Html.BeginForm("SubmitForm", "Forms", FormMethod.Post, new { @id = "FormSubmit" }))
    {
        @Html.Hidden("formId", Model.TblForm.FormId)
        @Html.Hidden("UniqueId", UniqId)
        @Html.Hidden("SubmittedBy", CurrentUser.Name)

        @foreach (var question in Model.TblQuestionsList)
        {
            <div class="question-card mb-3">
                <label class="question-title" for="question-@question.QuestionId">
                    @if (question.QuestionType == 1)
                    {
                        <i class="fas fa-pencil-alt"></i>
                    }
                    else if (question.QuestionType == 2)
                    {
                        <i class="fas fa-paragraph"></i>
                    }
                    else if (question.QuestionType == 4)
                    {
                        <i class="fas fa-sort-numeric-up"></i>
                    }
                    else if (question.QuestionType == 3)
                    {
                        <i class="fas fa-check-square"></i>
                    }
                    @question.Question
                </label>

                @if (question.QuestionType == 1)
                {
                    <input type="text" name="answers[@question.QuestionId]" class="form-control" id="question-@question.QuestionId" placeholder="Enter your answer" required />
                }
                else if (question.QuestionType == 2)
                {
                    <textarea name="answers[@question.QuestionId]" class="form-control" id="question-@question.QuestionId" placeholder="Enter your answer" required></textarea>
                }
                else if (question.QuestionType == 4)
                {
                    <input type="number" name="answers[@question.QuestionId]" class="form-control" id="question-@question.QuestionId" placeholder="Enter your answer" required />
                }
                else if (question.QuestionType == 3)
                {
                    foreach (var option in Model.tblQuestionOptionList.Where(o => o.QuestionId == question.QuestionId))
                    {
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="answers[@question.QuestionId]" value="@option.OptionText" id="option-@option.OptionId" required />
                            <label class="form-check-label" for="option-@option.OptionId">@option.OptionText</label>
                        </div>
                    }
                }
            </div>
        }

        <button type="submit" class="btn btn-primary btn-block"><i class="fas fa-check"></i> Submit</button>
    }

    <!-- Like/Unlike Section -->
    <div class="like-container d-flex justify-content-start align-items-center mt-4">
        @if (!hasLiked)
        {
            <form method="post" asp-controller="Forms" id="LikeForm" asp-action="Like">
                <input type="hidden" asp-for="@Model.tblLike.FormId" value="@Model.TblForm.FormId" />
                <input type="hidden" asp-for="@Model.tblLike.UserId" value="@userId" />
            </form>

            <button type="submit" id="LikeButton" class="btn btn-outline-primary btn-sm mb-4">
                <i class="fas fa-thumbs-up"></i> Like
            </button>
        }
        else
        {
            <button id="UnLikeButton" class="btn btn-outline-danger btn-sm mb-4">
                <i class="fas fa-thumbs-down"></i> Unlike
            </button>
        }

        <p class="likes-count mt-3 ms-2 text-muted">
            <span class="">@Model.TblForm.Likes</span>
            @if (@Model.TblForm.Likes > 1)
            {
                <span>Likes</span>
            }
            else
            {
                <span>Like</span>
            }
        </p>
    </div>
</div>

<script>
    $(document).ready(function () {
        const formId = @Model.TblForm.FormId;
        const userId = '@userId' || null;

        // Handle Unlike button click
        $('#UnLikeButton').on('click', function () {
            $.ajax({
                url: `/Forms/Unlike?formId=${formId}`,
                type: 'POST',
                success: function (response) {
                    location.reload();
                    console.log('Successfully unliked the form');
                },
                error: function (xhr, status, error) {
                    console.error('Error unliking the form:', error);
                }
            });
        });

        // Handle Like button click
        $("#LikeButton").on("click", function () {
            $.ajax({
                async: true,
                cache: false,
                url: '/Forms/Like?formId=${formId}',
                type: 'POST',
                data: $("#LikeForm").serialize(),
                success: function () {
                    location.reload();
                    console.log("success");
                },
                error: function (xhr, status, error) {
                    console.error(error);
                }
            });
        });
    });
</script>
